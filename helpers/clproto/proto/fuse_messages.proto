/**
 * Communication protocol between FUSE client and the server.
 * @author Krzysztof Trzepla
 * @copyright (C) 2015 ACK CYFRONET AGH
 * @copyright This software is released under the MIT license cited in
 * 'LICENSE.txt'
 */

package one.clproto;

import "common_messages.proto";

enum FileType {
    REG = 1; // regular file
    DIR = 2; // directory
    LNK = 3; // symbolic link
}

enum EntryType {
    PATH = 1; // Path to the file
    UUID = 2; // UUID of the file
}

enum FileLocationFlags {
    READ = 1;
    WRITE = 2;
    READ_WRITE = 3;
}

// Generic FUSE client request
message FuseRequest {
    oneof fuse_request { // list of all FUSE client requests
        GetFileAttr get_file_attr = 1;
        GetFileChildren get_file_children = 2;
        CreateDir create_dir = 3;
        DeleteFile delete_file = 4;
        UpdateTimes update_times = 5;
        ChangeMode change_mode = 6;
        Rename rename = 7;
        GetNewFileLocation get_new_file_location = 8;
        GetFileLocation get_file_location = 9;
        GetHelperParams get_helper_params = 10;
        Release release = 11;
        Truncate truncate = 12;
        GetXattr get_xattr = 13;
        SetXattr set_xattr = 14;
        RemoveXattr remove_xattr = 15;
        ListXattr list_xattr = 16;
        SynchronizeBlock synchronize_block = 17;
        CreateStorageTestFile create_storage_test_file = 18;
        VerifyStorageTestFile verify_storage_test_file = 19;
        GetParent get_parent = 20;
        SynchronizeBlockAndComputeChecksum synchronize_block_and_compute_checksum = 21;
        GetAcl get_acl = 22;
        SetAcl set_acl = 23;
        RemoveAcl remove_acl = 24;
        GetTransferEncoding get_transfer_encoding = 25;
        SetTransferEncoding set_transfer_encoding = 26;
        GetCdmiCompletionStatus get_cdmi_completion_status = 27;
        SetCdmiCompletionStatus set_cdmi_completion_status = 28;
        GetMimetype get_mimetype = 29;
        SetMimetype set_mimetype = 30;
        GetFilePath get_file_path = 31;
        FSync fsync = 32;
        GetFileDistribution get_file_distribution = 33;
        ReplicateFile replicate_file = 34;
    }
}

message GetFileAttr {
    required EntryType entry_type = 1;
    required bytes entry = 2;
}

message GetFileChildren {
    required bytes uuid = 1;
    required int32 offset = 2 [default = 0];
    optional int32 size = 3;
}

message CreateDir {
    required bytes parent_uuid = 1;
    required bytes name = 2;
    required uint32 mode = 3;
}

message DeleteFile {
    required bytes uuid = 1;
}

message UpdateTimes {
    required bytes uuid = 1;
    optional int64 atime = 2 [default = -1];
    optional int64 mtime = 3 [default = -1];
    optional int64 ctime = 4 [default = -1];
}

message ChangeMode {
    required bytes uuid = 1;
    required int32 mode = 2;
}

message Rename {
    required bytes uuid = 1;
    required bytes target_path = 2;
}

message GetNewFileLocation {
    required bytes name = 1;
    required bytes parent_uuid = 2;
    required uint32 mode = 3;
    optional FileLocationFlags flags = 4 [default = READ_WRITE];
}

message GetFileLocation {
    required bytes uuid = 1;
    optional FileLocationFlags flags = 2 [default = READ_WRITE];
}

message GetHelperParams {
    required bytes storage_id = 1;
    optional bool force_proxy_io = 2 [default = false];
}

message Truncate {
    required bytes uuid = 1;
    required int64 size = 2;
}

message Release {
    required bytes uuid = 1;
    required bytes handle_id = 2;
}

message GetParent {
    required bytes uuid = 1;
}

message Acl {
    required bytes value = 1;
}

message GetAcl {
    required bytes uuid = 1;
}

message SetAcl {
    required bytes uuid = 1;
    required Acl acl = 2;
}

message RemoveAcl {
    required bytes uuid = 1;
}

message GetTransferEncoding {
    required bytes uuid = 1;
}

message SetTransferEncoding {
    required bytes uuid = 1;
    required bytes value = 2;
}

message GetCdmiCompletionStatus {
    required bytes uuid = 1;
}

message SetCdmiCompletionStatus {
    required bytes uuid = 1;
    required bytes value = 2;
}

message GetMimetype {
    required bytes uuid = 1;
}

message SetMimetype {
    required bytes uuid = 1;
    required bytes value = 2;
}

message GetFilePath {
    required bytes uuid = 1;
}

message FSync {
    required bytes uuid = 1;
}

message GetFileDistribution {
    required bytes uuid = 1;
}

message ReplicateFile {
    required bytes uuid = 1;
    required bytes provider_id = 2;
    optional FileBlock block = 3;
}

// Generic FUSE client response
message FuseResponse {
    required Status status = 1;

    oneof fuse_response { // list of all FUSE client responses
        FileAttr file_attr = 2;
        FileChildren file_children = 3;
        FileLocation file_location = 4;
        HelperParams helper_params = 5;
        Xattr xattr = 6;
        XattrList xattr_list = 7;
        StorageTestFile storage_test_file = 8;
        Dir dir = 9;
        Checksum checksum = 10;
        TransferEncoding transfer_encoding = 11;
        CdmiCompletionStatus cdmi_completion_status = 12;
        Mimetype mimetype = 13;
        Acl acl = 14;
        FilePath file_path = 15;
        FileDistribution file_distribution = 16;
    }
}

message FileAttr {
    required bytes uuid = 1;
    required bytes name = 2;
    required int32 mode = 3;
    required int32 uid = 4;
    required int32 gid = 5;
    required int64 atime = 6;
    required int64 mtime = 7;
    required int64 ctime = 8;
    required FileType type = 9;
    optional int64 size = 10 [default = 0];
}

message FileChildren {
    repeated ChildLink child_links = 1;
}

message FileLocation {
    required bytes uuid = 1;
    required bytes provider_id = 2;
    required bytes space_id = 3;
    required bytes storage_id = 4;
    required bytes file_id = 5;
    repeated FileBlock blocks = 6;
    optional bytes handle_id = 7;
}

message HelperArg {
    required string key = 1;
    required string value = 2;
}

message HelperParams {
    required bytes helper_name = 1;
    repeated HelperArg helper_args = 2;
}

message GetXattr {
    required bytes uuid = 1;
    required bytes name = 2;
}

message SetXattr {
    required bytes uuid = 1;
    required Xattr xattr = 2;
}

message RemoveXattr {
    required bytes uuid = 1;
    required bytes name = 2;
}

message ListXattr {
    required bytes uuid = 1;
}

message Xattr {
    required bytes name = 1;
    required bytes value = 2;
}

message XattrList {
    repeated bytes names = 1;
}

message CreateStorageTestFile {
    required bytes storage_id = 1;
    required bytes file_uuid  = 2;
}

message StorageTestFile {
    required HelperParams helper_params = 1;
    required bytes        space_uuid    = 2;
    required bytes        file_id       = 3;
    required bytes        file_content  = 4;
}

message VerifyStorageTestFile {
    required bytes storage_id   = 1;
    required bytes space_uuid   = 2;
    required bytes file_id      = 3;
    required bytes file_content = 4;
}

message SynchronizeBlock {
    required bytes     uuid  = 1;
    required FileBlock block = 2;
}

message Dir {
    required bytes uuid = 1;
}

message SynchronizeBlockAndComputeChecksum {
    required bytes     uuid  = 1;
    required FileBlock block = 2;
}

message Checksum {
    required bytes value = 1;
}

message TransferEncoding {
    required bytes value = 1;
}

message CdmiCompletionStatus {
    required bytes value = 1;
}

message Mimetype {
    required bytes value = 1;
}

message FilePath {
    required bytes value = 1;
}

message ProviderFileDistribution {
    required bytes provider_id = 1;
    repeated FileBlock blocks = 2;
}

message FileDistribution {
    repeated ProviderFileDistribution provider_file_distributions = 1;
}
