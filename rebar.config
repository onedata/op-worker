%% behaviours should be compiled before other files
{erl_first_files, [
    "src/cluster_elements/worker_host/worker_plugin_behaviour.erl",
    "src/http/rest/protocol_plugin_behaviour.erl",
    "src/modules/fslogic/security_annotations/check_permissions.erl"
]}.

%% directory for releases
{sub_dirs, ["rel"]}.

%% to include deps headers
{lib_dirs, ["deps"]}.

%% eunit opts - Maven-like output formatting
{eunit_opts, [verbose, {report, {eunit_surefire, [{dir, "../test/eunit_results"}]}}]}.

%% Test coverage
% {cover_enabled, true}. @todo https://github.com/ivanos/dobby_core_lib/issues/11
% {cover_export_enabled, true}.

%% deps options
{deps, [
    {ctool, "2.0.2", {git, "${ONEDATA_GIT_URL}/ctool.git", {tag, "cf0b2ce4"}}},
    {cluster_worker, "2.0.1", {git, "${ONEDATA_GIT_URL}/cluster-worker.git", {tag, "ef93c0a9"}}},
    {gui, "1.0.2", {git, "${ONEDATA_GIT_URL}/gui.git", {tag, "1.0.2"}}},
    {clproto, "2.0.0", {git, "${ONEDATA_GIT_URL}/clproto.git", {tag, "a982eb9f959"}}},
    {meck, "0.8.2", {git, "https://github.com/eproxus/meck.git", {tag, "0.8.2"}}},
    {gen_server_mock, ".*", {git, "git://github.com/brucexin/gen_server_mock.git", {tag, "de3cd8e"}}},
    %% parse_trans repeated from ctool to fetch it before annotations' inner dependency
    {parse_trans, "2.9.2", {git, "https://github.com/uwiger/parse_trans.git", {tag, "2.9.2"}}},
    {annotations, ".*", {git, "https://github.com/RoXeon/annotations.git", {tag, "4c31a8b"}}},
    {riakc, ".*", {git, "git://github.com/basho/riak-erlang-client.git", {tag, "527722d"}}},
    {node_package, ".*", {git, "git://github.com/onedata/node_package.git", {branch, "2.0.2"}}}
]}.

%% plugins
{plugins, [rebar_git_plugin, rebar_annotations_plugin]}.

%% pre-hooks
{pre_hooks, [
    {eunit, "mkdir -p test/eunit_results"}, %% Make dir for eunit' surefire test results
    %% Sometimes, in some cases epmd daemon doesn't start during eunit tests,
    %% so we need to force start it
    {eunit, "epmd -daemon"},
    %% Helpers compilation
    {clean, "make -C helpers/ clean"},
    {compile, "make LDFLAGS= CFLAGS= CXXFLAGS= INSTALL_PREFIX=`pwd`/priv/helpers BUILD_PROXY_IO=OFF -C helpers/ install"},
    {compile, "rm -rf `pwd`/priv/helpers/**/*.so"},
    %% bamboos compilation
    {compile, "make -C bamboos compile"},
    {clean, "make -C bamboos clean"},
    {clean, "make gui_clean"},
    %% dir for compiled C libs
    {compile, "mkdir -p priv"}
]}.

{post_hooks, [
    {compile, "rm -rf priv/*.a"},
    {compile, "rm -rf c_src/*.o"}
]}.

%% erlang NIF specification
{port_specs, [
    {"priv/csr_creator_drv.so", ["c_src/csr_creator.cc", "c_src/csr_creator_nif.cc"]},
    {"priv/helpers_nif.so", ["c_src/helpers/helpers_nif.cc"]},
    {"priv/rt_priority_queue_drv.so", [
        "c_src/rtransfer/rt_priority_queue_nif.cc",
        "c_src/rtransfer/rt_interval.cc",
        "c_src/rtransfer/rt_block.cc",
        "c_src/rtransfer/rt_priority_queue.cc"]},

    {"priv/rt_map_drv.so", [
        "c_src/rtransfer/rt_map_nif.cc",
        "c_src/rtransfer/rt_block.cc",
        "c_src/rtransfer/rt_map.cc"]}
]}.

%% erlang NIF compilation flags
{port_env, [
    {"LDFLAGS", "$LDFLAGS `pkg-config --libs botan-1.10` -Wl,-rpath"
    " -Wl,\\$ORIGIN/helpers/lib -L `pwd`/priv/helpers/lib -lhelpers"
    " -lboost_filesystem -lrados -ls3 -lglog"},
    {"CXXFLAGS", "$CXXFLAGS -std=c++14 -O2 -Wall `pkg-config --cflags"
    " botan-1.10` -isystem `pwd`/priv/helpers/include -D_FILE_OFFSET_BITS=64"
    " -DASIO_STANDALONE"},
    {"DRV_LINK_TEMPLATE", "$CXX $PORT_IN_FILES $LDFLAGS $DRV_LDFLAGS"
    " -o $PORT_OUT_FILE"}
]}.

%% Cleanup
{clean_files, [
    "test/eunit_results",
    "priv/*.so",
    "priv/helpers",
    "test_distributed/logs/*",
    "test_distributed/*.beam"
]}.

%% Erlang options, defines
{erl_opts, [{src_dirs, ["src"]}]}.
%% Add the tuple below to erl_opts proplist to turn on lager parse transform
%% (this is not needed as long as ctool logger is used)
%% {parse_transform, lager_transform}
%% Add the tuple below to erl_opts proplist to completely turn off debug messages
%% {d, skip_debug}
